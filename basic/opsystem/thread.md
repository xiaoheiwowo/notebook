# 线程



### 为什么使用线程

- 进程使用中存在的问题
    - 进程间如何通信，共享数据
    - 进程的切换开销较大：创建进程需要分配资源，简历PCB；撤销进程是，需要回收资源，撤销PCB；进程切换时需保存进程的状态信息。

- 希望有一种实体满足以下特定
    - 多个实体之间可以并发的执行
    - 实体之间共享内存空间

### 什么是线程

- 定义：**进程当中的一条执行流程**
- 从两个方面重新理解进程
    - 从资源组合的角度：进程把一组相关的资源组合起来，构成了一个资源平台（环境），包括地址空间（代码段、数据段）、打开的文件等各种资源；
    - 从运行的角度：代码在这个资源平台上的一条执行流程（线程）

- 线程的优点： 

    - 一个进程可以同时存在多个线程
    - 各个线程之间可以并发的执行
    - 各个线程之间可以共享地址空间和文件等资源

- 线程的缺点

    - 一个线程奔溃，会导致其所属进程的所有线程奔溃。

- ![image-20200117222711826](../../pic/image-20200117222711826.png)

- 线程所需资源

    - 多线程模式，每个线程有自己独立的栈，寄存器以保证自己的流程执行；共享堆，数据区，代码段，文件
    - 单线程模式

- 进程和线程的比较

    - 进程是资源分配单位，线程是cpu调度单位
    - 进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和堆栈
    - 线程同样具有就绪、阻塞和执行三种基本状态，同样具有状态之间的转换关系；
    - 线程能减少并发执行的时间和空间开销：
        - 线程的创建时间比进程短；
        - 线程的终止时间比进程短；
        - 同一进程内的线程切换时间比进程短；有相同的内存页表
        - 由于同一进程的各线程间共享内存和文件资源，可直接进行不通过内核的通信

    

### 线程的实现

- 主要有三种实现方式
    - 用户线程：在用户空间实现，操作系统看不到的，由应用程序库管理；POSIX Pthreads，Mach C-threads， Solaris threads
        - ![image-20200118205319637](../../pic/image-20200118205319637.png)
        - 在用户空间实现的线程机制，它不依赖于操作系统的内核，有一组用户级的线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度。
            - 由于用户线程的维护由相应的进程来完成（通过线程库函数），不需要操作系统内核了了解用户线程的存在，可用于不支持线程技术的多进程操作系统。
            - 每个进程都需要它自己私有的线程控制块（TCB）列表，用来跟踪记录它的各个线程的状态信息（PC、栈指针、寄存器），TCB由线程库函数来维护；
            - 每个线程的切换也是由线程库函数来完成的，无需用户态/核心态切换，所以速度特别快；
            - 允许每个进程拥有自己的线程调度算法。
        - 用户线程的缺点：
            - 阻塞性的系统调用如何实现？如果一个线程发起系统调用而阻塞，则整个进程在等待
            - 当一个线程开始运行后，除非它主动地交出CPU的使用权，否则它所在的进程当中的其他线程将无法运行；
            - 由于时间片分配给进程，故与其他进程比，在多线程执行时，每个线程得到的时间片较少，执行会较慢。
    - 内核线程：在内核空间实现，由操作系统管理；Windows，Solaris，Linux
        - ![image-20200118205204815](../../pic/image-20200118205204815.png)
        - 是指在操作系统的内核当中实现一种线程机制，由操作系统的内核来完成线程的创建、终止和管理。
            - 在支持内核线程的操作系统中，由内核来维护的进程和线程的上下文信息（PCB和TCB）
            - 线程的创建、终止和切换都是通过系统调用/内核函数的方式来进行，由内核来完成，因此系统开销较大；
            - 在一个进程中，如果某个内核线程发起系统调用而被阻塞，并不会影响其他内核线程的运行
            - 时间片分配给线程，多线程的进程获得更多的CPU事件；
            - Windows 支持内核线程
    - 轻量级进程：在内核中实现，支持用户线程；Solaris/Linux （LightWeight Process）
        - ![image-20200118205942053](../../pic/image-20200118205942053.png)
- 用户线程和内核线程的对应关系
    - 多对一：多个用于线程对一个内核线程
    - 一对一：
    - 多对多：？？

- - - 

### 多线程编程接口举例



