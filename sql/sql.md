

## 数据库基础



- 查询代价

```
响应时间 = 磁盘存取（主要耗时） + CPU计算 + 传输
磁盘存取 = 寻道操作次数 * 平均寻道时间 + 读取磁盘块数量 * 平均读取时间 + 写入磁盘块数量 * 平均写入时间
实际一般以传输磁盘块数量作为度量
```



- 查询过程

```
SQL语句 
=> 语法分析 （语法树）
=> 初始逻辑查询计划 （关系代数表达式树）		 编译 元数据 统计数据
=> 优化逻辑查询计划 
=> 创建并优化物理查询计划 
=> 查询执行引擎 
=> 查询结果

```

### 关系代数

- 基本运算
    - 选择(where)： $\sigma_{attr} = _{"relation" \bigwedge val > 9000} (instructor)$
    - 投影：
    - 并：
    - 集合差：
    - 笛卡尔积：



```
缓冲，预读，调度，文件组织
```

### 数据库故障和恢复

- 输入错误 程序检查

- 系统错误 数据库恢复子系统 事务和日志

  - 事务（ACID）

    - 原子性：不可分割
    - 一致性：事务完成后数据库状态一致，数据库的完整性没有被破坏
    - 隔离性：多用户使用互不干扰 

    ```
    隔离级别：读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）
    ```

    

    - 持久性：事务完成后数据持久保持

- 介质故障-校验、raid阵列

- 灾难-远程备份

```
事务
事务管理器
查询管理器
日志管理器
恢复管理器

事务的局部地址空间 <=> 缓存区管理器所管理的内存地址 <=> 磁盘
BEGIN TRANSATION
ROLLBACK
COMMIT
```

```
日志
* <START T> 事务的开始
* <COMMIT T> 事务成功
* <ABORT T> 事务失败
* <T2, Update, A, 100, 200> 跟新数据库数据
* 检查点记录 <START CKPT T1> <END CKPT>

undo 先提交，提交完成后刷新日志
redo 先写日志
undo/redo

```

```
http://www.zsythink.net/archives/1233/
https://www.jianshu.com/p/d829df873332
```

### 锁

- 共享锁 S锁：事务A对数据M加上S锁，事务A只能读数据M，其他事务也可以读数据M
- 排它锁 X锁：事务A对数据M加上X锁，事务A可以读写数据M，其他事务不能访问数据M

。，。，。，。，

- 悲观锁(Pessimistic[ˌpesɪˈmɪstɪk] Lock)

对数据被外界修改保持保守态度，在整个数据处理过程中，数据处于锁定状态，依赖于数据库提供的锁机制。

- 乐观锁(Optimistic[ˌɑ:ptɪˈmɪstɪk]Lock)

采用宽松的加锁机制，基于数据版本记录机制，具体做法：数据库表增加一个”version”字段来实现，读取数据时，将版本号一同读出，之后更新，对版本号加1，将提交数据的版本数据与数据库对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库的数据，则予以更新，否则，被认为是过期数据。

```
https://segmentfault.com/a/1190000004469395
```



脏读：事务A读到事务B修改未提交的数据

不可重复读：一个事务中两次读到的数据不一样，期间另一个事务提价改变了数据

幻读：??????

| 隔离级别         | 脏读可能性 | 不可重复读可能性 | 幻读可能性 | 加锁读 |
| :--------------- | :--------- | :--------------- | :--------- | :----- |
| READ-UNCOMMITTED | Y          | Y                | Y          | N      |
| READ-COMMITTED   | N          | Y                | Y          | N      |
| REPEATABLE-READ  | N          | N                | Y          | N      |
| SERIALIZABLE     | N          | N                | N          | Y      |

### 事务隔离性级别的实现

- 锁
- 读写时间戳
- 多版本和快照隔离
- 





串行化调度

一致性调度





锁：数据访问数据的志， 共享锁s，排他锁x

错误加锁 死锁 饿死（一直有事务申请共享锁导致需要排它锁的事务永远拿不到锁，通过增加事务优先等级解决）

级联回滚

两阶段锁协议，事务分为两个阶段，一个阶段只能加锁，另一个阶段只能解锁

严格两阶段锁协议，提交前不能释放排它锁

强两阶段锁协议，提交前不能解锁

锁转换机制，先获取共享锁，在写之前转换为排它锁，写完再转回共享锁

多粒度锁及意向锁

锁管理器



死锁预防，抢占和回滚，超时机制

死锁检验，死锁等待图，有环就发生了死锁，需要回滚

