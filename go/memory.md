# 内存管理

- 用户程序 mutator
- 分配器 allocator
- 收集器 collector

## 内存区域

- Stack

函数参数，返回值以及部分局部变量

- Heap

其他



## 分配器

- 基本分配方法
  - 线性分配器，维护一个指向空闲内存的指针来分配内存，实现容易，效率高O(1)，但是无法重新利用被回收的内存块
    - 垃圾回收算法
      - 标记压缩
      - 复制回收
      - 分代回收
      - 
  - 空闲链表分配器，维护一个空闲的内存的链表，当用户需要内存时，遍历链表O(n)找到内存块进行分配。
    - 几种链表构造/分配策略
      - 首次适应
      - 循环首次适应
      - 最优适应
      - 隔离适应：按照不同大小对内存块分类管理，分配内存时从大小合适的链表中取

- 分级分配
  -  TCMalloc 线程缓存分配，使用多级缓存将对象根据大小分类，并按照类别实施不同的分配策略
  - 三种对象：微对象<16B，16B<=小对象<=23KB，大对象 > 32KB
  - 多级缓存：线程缓存，中心缓存，页堆
    - 线程缓存为线程独享，不需要加锁，性能高
- 虚拟内存布局，1.11 后支持不连续的内存使用
  - 堆区的线性内存 1.10 之前
    - spans 512M，存志向内存管理单元 runtime.mspan 的指针
    - bitmap 16G，标记 arena 区内存使用情况，每个字节标记 arena 区 32 字节
    - arena 512G，每页 8 K

